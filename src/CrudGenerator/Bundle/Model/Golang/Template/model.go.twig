package models

{% set createdField = table.fieldWithName('date_created') %}
{% set updatedField = table.fieldWithName('date_updated') %}
{% set dateField = table.fieldWithName('date') or table.fieldWithName('fecha') or table.fieldWithName('_at') %}
{% set slugField = table.fieldWithName('slug') %}
{% set nameField = table.fieldWithName('name') %}
import (
{% if dateField is not empty %}
    "time"
{% endif %}
    "github.com/jinzhu/gorm"
    "{{ config.project.package }}/modules/validator"
{% if slugField is not empty and nameField is not empty %}
    "{{ config.project.package }}/modules/util"
{% endif %}
)

{% set tableName = table.name | upperCamelize %}
{% set tableSingleKey = table.name | slice(0,1) %}
{% set table_name = table.name | underscored %}

//{{ tableName }} ...
type {{ tableName }} struct {
{% for field in table.fields  %}{% spaceless %}
    {% set type = golang.realType(field) %}
    {% set column = field.name | underscored %}
    {% set property = golang.primaryName(field.name) | upperCamelize %}
    {% set allowUseNull = (type | contains('time') or field.foreign) %}
    {% set validPrefix = ''  %}
    {% set validSuffix = ''  %}

    {% if field.name | contains('email') %}
        {% set validPrefix = 'email'  %}
    {% endif %}
    {% if field.allowNull and validPrefix is not empty %}
        {% set validSuffix = 'optional'  %}
    {% endif %}
    {% if validSuffix is empty and not field.allowNull %}
        {% set validSuffix = 'required'  %}
    {% elseif validSuffix is empty %}
        {% set validSuffix = '-'  %}
    {% endif %}
    {% if field.primary %}
        {% set validSuffix = '-' %}
    {% endif %}
{% endspaceless %}
    {{ property }} {{ field.allowNull and allowUseNull  ? '*' : '' }}{{ type }} `gorm:"{{ field.primary ? 'primary_key;' : '' }}{{ field.autoIncrement ? 'auto_increment;' : '' }}type:{{ field.type.originalName }};{{ field.unique ? 'unique;' : '' }}{{ not field.allowNull ? 'not null;' : '' }}{% spaceless %}
    {% spaceless %}{% if field.default is not empty %}
    default:{{ field.default }};
    {% endif %}
    {% endspaceless %}{% for index in field.indexes  %}{% spaceless %}
    {% if index.name != "PRIMARY" %}
        {% if index.unique %}
        unique_index:{{ index.name }};
        {% else %}
        index:{{ index.name }};
        {% endif %}
    {% endif %}
    {% endspaceless %}{% endfor %}
    {% endspaceless %}column:{{ column}}" json:"{{ column}}{{ field.allowNull ? ',omitempty' : '' }}"`
{% endfor %}

{% for field in table.foreignFields  %}{% spaceless %}
    {% set type = golang.type(field) %}
    {% set property = field.name | replace({'_id':'','id_':''}) | upperCamelize %}
    {% set column = field.name | replace({'_id':'','id_':''})  | underscored %}
    {% set allowNull = field.foreign and field.allowNull  %}
{% endspaceless %}
    {{ property }} {{ allowNull ? '*' : '' }}{{ type }} `gorm:"foreignkey:{{ golang.primaryName(field.reference.column) | upperCamelize }}" json:"{{ column}}{{ allowNull ? ',omitempty' : '' }}" sql:"-"`
{% endfor %}
}

//{{ tableName }}List ...
type {{ tableName }}List struct {
    Total  int      `json:"total"`
    Limit  int      `json:"limit"`
    Offset int      `json:"offset"`
    Items  []{{ tableName }} `json:"items"`
}

//TableName ...
func ({{ tableName }}) TableName() string {
    return "{{ table_name }}"
}


//IsValid ...
func ({{ tableSingleKey }} *{{ tableName }}) IsValid() error {
    return validator.Validate({{ tableSingleKey }})
}

//BeforeCreate ...
func ({{ tableSingleKey }} *{{ tableName }}) BeforeCreate(scope *gorm.Scope) error {
    {% if createdField is not empty %}
        created := time.Now()
        {{ tableSingleKey }}.{{ createdField.name | upperCamelize }} = {{ createdField.allowNull ? '&' : '' }}created
    {% endif %}
    {% if slugField is not empty and nameField is not empty %}
        if {{ tableSingleKey }}.{{ slugField.name | upperCamelize }}==""{
            {{ tableSingleKey }}.{{ slugField.name | upperCamelize }} = util.Slug({{ tableSingleKey }}.{{ nameField | upperCamelize }})
        }
    {% endif %}

    return {{ tableSingleKey }}.IsValid()
}

//BeforeUpdate ...
func ({{ tableSingleKey }} *{{ tableName }}) BeforeUpdate(scope *gorm.Scope) error {
    {% if updatedField is not empty %}
        updated := time.Now()
        scope.SetColumn("{{ updatedField.name }}", {{ updatedField.allowNull ? '&' : '' }}updated)
    {% endif %}
    {% if slugField is not empty and nameField is not empty %}
        if {{ tableSingleKey }}.{{ slugField.name | upperCamelize }}==""{
        scope.SetColumn("{{ slugField.name }}",  util.Slug({{ nameField | upperCamelize }}))
        }
    {% endif %}
    return {{ tableSingleKey }}.IsValid()
}
