//Package models ...
package models

import (
    "time"
    "github.com/jinzhu/gorm"
    "github.com/juju/errors"
    "app.com/api/modules/validator"
    "app.com/api/modules/db"
)

{% set tableName = table.name | upperCamelize %}
{% set tableSingleKey = table.name | slice(0,1) %}
{% set table_name = table.name | underscored %}

//{{ tableName }} ...
type {{ tableName }} struct {
{% for field in table.fields  %}{% spaceless %}
    {% set type = golang.realType(field) %}
    {% set column = field.name | underscored %}
    {% set property = golang.primaryName(field.name) | upperCamelize %}
{% endspaceless %}
    {{ property }} {{ type }} `gorm:"column:{{ column}}" json:"{{ column}}" form:"{{ column}}"`
{% endfor %}

{% for field in table.foreignFields  %}{% spaceless %}
    {% set type = golang.type(field) %}
    {% set property = field.name | replace({'_id':''}) | upperCamelize %}
    {% set column = field.name | replace({'_id':''})  | underscored %}
    {% set isNullable = field.foreign and field.allowNull  ? '*' : '' %}
{% endspaceless %}
    {{ property }} {{ isNullable }}{{ type }} `gorm:"-" json:"{{ column}}" form:"-" sql:"-"`
{% endfor %}
}

//{{ tableName }}List ...
type {{ tableName }}List struct {
    Total  int      `json:"total" form:"total"`
    Limit  int      `json:"limit" form:"limit"`
    Offset int      `json:"offset" form:"offset"`
    Items  []{{ tableName }} `json:"items" form:"items"`
}

//TableName ...
func ({{ tableName }}) TableName() string {
    return "{{ table_name }}"
}

{% set createdField = table.fieldWithName('date_created') %}
{% set updatedField = table.fieldWithName('date_updated') %}
//BeforeCreate ...
func ({{ tableSingleKey }} *{{ tableName }}) BeforeCreate(scope *gorm.Scope) error {
    {% if createdField is not empty %}
        {{ tableSingleKey }}.DateCreated = time.Now()
    {% endif %}
    {% if updatedField is not empty %}
        {{ tableSingleKey }}.DateUpdated = time.Now()
    {% endif %}
    return validator.Validate({{ tableSingleKey }})
}

//BeforeUpdate ...
func ({{ tableSingleKey }} *{{ tableName }}) BeforeUpdate(scope *gorm.Scope) error {
    {% if updatedField is not empty %}
        {{ tableSingleKey }}.DateUpdated = time.Now()
    {% endif %}
    return validator.Validate({{ tableSingleKey }})
}

//List ...
func ({{ tableSingleKey }} {{ tableName }}) List(offset, limit int) (list {{ tableName }}List, err error) {

    admDB, err := db.SetupAdmin()
    if err != nil {
        return list, err
    }
    defer admDB.Close()

    list = {{ tableName }}List{Limit: limit, Offset: offset}
    qb := admDB.Model({{ tableSingleKey }})
    err = {{ tableSingleKey }}.preload(qb).
        Offset(offset).
        Limit(limit).
        Find(&list.Items).
        Error

    if err != nil {
        return list, err
    }
    err = qb.Count(&list.Total).Error
    if err != nil {
        list.Total = len(list.Items)
    }

    return list, nil
}


{% set nameField = table.fieldWithName('name') %}
{% if nameField is not empty %}
//SearchList ...
func ({{ tableSingleKey }} {{ tableName }}) SearchList(query string, offset, limit int) (list {{ tableName }}List, err error) {

    admDB, err := db.SetupAdmin()
    if err != nil {
        return list, err
    }
    defer admDB.Close()

    list = {{ tableName }}List{Limit: limit, Offset: offset}
    qb := {{ tableSingleKey }}.preload(admDB.Model({{ tableSingleKey }}).
        Offset(offset).
        Limit(limit).
        Where("name LIKE ?", "%"+query+"%"))

    err = qb.Find(&list.Items).
        Error

    if err != nil {
        return list, err
    }
    err = qb.Count(&list.Total).Error
    if err != nil {
        list.Total = len(list.Items)
    }

    return list, nil
}
{% endif %}

{% set primaryFieldName = golang.primaryName(table.primaryField.name) | upperCamelize  %}
{% set primaryFieldProperty = primaryFieldName  %}
{% set primaryFieldParam = primaryFieldName  %}
{% set primaryFieldType = golang.realType(table.primaryField) %}


//FindOneBy{{ primaryFieldProperty }} ...
func ({{ tableSingleKey }} *{{ tableName }}) FindOneBy{{ primaryFieldProperty }}({{ primaryFieldParam }} {{ primaryFieldType }}) error {

    if {{ primaryFieldParam }} < 1 {
        return errors.New("invalid")
    }

    return {{ tableSingleKey }}.findOne({{ tableName }}{{ '{' }}{{ primaryFieldProperty }}: {{ primaryFieldParam }}{{ '}' }})
}


{% if nameField is not empty %}
{% set nameFieldName = nameField.name | upperCamelize  %}
{% set nameFieldProperty = nameFieldName  %}
{% set nameFieldParam = nameFieldName | camelize  %}
{% set nameFieldType = golang.type(nameField) %}
//FindOneByName ...
func ({{ tableSingleKey }} *{{ tableName }}) FindOneBy{{ nameFieldProperty }}({{ nameFieldParam }} {{ nameFieldType }}) error {

    if {{ nameFieldParam }} == "" {
        return errors.New("invalid")
    }

    return {{ tableSingleKey }}.findOne({{ tableName }}{{ '{' }}{{ nameFieldProperty }}: {{ nameFieldParam }}{{ '}' }})
}
{% endif %}
//Create ...
func ({{ tableSingleKey }} *{{ tableName }}) Create() error {

    admDB, err := db.SetupAdmin()
    if err != nil {
        return err
    }
    defer admDB.Close()

    err = admDB.Create(&{{ tableSingleKey }}).Error
    if err != nil {
        return err
    }

    err = {{ tableSingleKey }}.FindOneBy{{ primaryFieldProperty }}({{ tableSingleKey }}.{{ primaryFieldProperty }})
    if err != nil {
        return err
    }

    return nil

}

//Update ...
func ({{ tableSingleKey }} *{{ tableName }}) Update() error {

    admDB, err := db.SetupAdmin()
    if err != nil {
        return err
    }
    defer admDB.Close()

    err = admDB.Save(&{{ tableSingleKey }}).Error
    if err != nil {
        return err
    }

    err = {{ tableSingleKey }}.FindOneBy{{ primaryFieldProperty }}({{ tableSingleKey }}.{{ primaryFieldProperty }})
    if err != nil {
        return err
    }

    return nil
}

//Delete ...
func ({{ tableSingleKey }} *{{ tableName }}) Delete() error {

    admDB, err := db.SetupAdmin()
    if err != nil {
        return err
    }
    defer admDB.Close()

    err = admDB.Delete(&{{ tableSingleKey }}).Error
    if err != nil {
        return err
    }
    return nil
}

func ({{ tableSingleKey }} *{{ tableName }}) findOne(query {{ tableName }}) error {

    admDB, err := db.SetupAdmin()
    if err != nil {
        return err
    }
    defer admDB.Close()

    err = {{ tableSingleKey }}.preload(admDB.Where(query)).First(&{{ tableSingleKey }}).Error
    if err != nil {
        return err
    }
    return nil
}

func ({{ tableSingleKey }} *{{ tableName }}) preload(query *gorm.DB) *gorm.DB {
    return query{% for field in table.foreignFields  %}{% spaceless %}
    {% set property = field.name | replace({'_id':''}) | upperCamelize %}.
    Preload("{{ property }}")
{% endspaceless %}{% endfor %}

}