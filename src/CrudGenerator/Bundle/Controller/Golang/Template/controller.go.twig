//Package controllers ...
package controllers

import (
    "fmt"
    "github.com/kataras/iris"
    "{{ config.project.package }}/controllers/middleware"
    "{{ config.project.package }}/models"
    "{{ config.project.package }}/modules/log"
    "{{ config.project.package }}/repositories"
)

{% set tableName = table.name | upperCamelize %}
{% set tableSingleKey = table.name | slice(0,1) %}
{% set table_name = table.name | underscored | replace({'_':'-'}) %}

{% set nameField = table.fieldWithName('name') %}

//{{ tableName }}Controller ...
func {{ tableName }}Controller(app *iris.Application) {

    app.Get("/{{ table_name }}",
        middleware.Database,
        //middleware.JWT.Serve,
        middleware.Permissions{Permissions: []string{"{{ table_name }}_read"}}.Serve,
        middleware.Log,
        middleware.Pagination,
        func(ctx iris.Context) {

        limit, _ := ctx.Params().GetInt("limit")
        offset, _ := ctx.Params().GetInt("offset")
        {% if nameField is not empty %}
        query := ctx.URLParam("query")
        {% endif %}
        //sort := ctx.URLParam("sort")
        //sortType := ctx.URLParam("sort_type")
        repo := repositories.New{{ tableName }}Repository(ctx)

        var err error
        var result models.{{ tableName }}List

        {% if nameField is not empty %}
        if query != "" {
            result, err = repo.SearchList(query, offset, limit)
        } else {
            result, err = repo.List(offset, limit)
            //result, err = repo.List(offset, limit, sort, sortType)
        }
        {% else %}
            result, err = repo.List(offset, limit)
            //result, err = repo.List(offset, limit, sort, sortType)
        {% endif %}
        if err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusInternalServerError)
            return
        }

        ctx.Header("X-Total", fmt.Sprint(result.Total))
        ctx.Header("X-Offset", fmt.Sprint(result.Offset))
        ctx.Header("X-Limit", fmt.Sprint(result.Limit))
        ctx.StatusCode(iris.StatusOK)
        ctx.JSON(result)

    })

{% set primaryFieldName = golang.primaryName(table.primaryField.name) | camelize  %}
{% set primaryFieldProperty = primaryFieldName | upperCamelize  %}
{% set primaryFieldParam = table.primaryField.name | camelize %}
{% set primaryFieldType = golang.realType(table.primaryField) %}

    app.Get("/{{ table_name }}/{{ '{' }}{{ primaryFieldParam }}:{{ primaryFieldType }} min(1){{ '}' }}",
        middleware.Database,
        //middleware.JWT.Serve,
        middleware.Permissions{Permissions: []string{"{{ table_name }}_read"}}.Serve,
        middleware.Log,
        func(ctx iris.Context) {

        id, _ := ctx.Params().Get{{ primaryFieldType | upperCamelize }}("{{ primaryFieldParam }}")

        repo := repositories.New{{ tableName }}Repository(ctx)
        item, err := repo.FindOneBy{{ primaryFieldProperty }}(id)
        if err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusNotFound)
            return
        }

        ctx.StatusCode(iris.StatusOK)
        ctx.JSON(item)

    })


    app.Post("/{{ table_name }}",
        middleware.Database,
        //middleware.JWT.Serve,
        middleware.Permissions{Permissions: []string{"{{ table_name }}_write"}}.Serve,
        middleware.Log,
        func(ctx iris.Context) {

        repo := repositories.New{{ tableName }}Repository(ctx)
        item := models.{{ tableName }}{}
        if err := ctx.ReadForm(&item); err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusBadRequest)
            return
        }

        result, err := repo.Create(item)
        if err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusInternalServerError)
            return
        }
        ctx.StatusCode(iris.StatusOK)
        ctx.JSON(result)

    })

    app.Put("/{{ table_name }}/{{ '{' }}{{ primaryFieldParam }}:{{ primaryFieldType }} min(1){{ '}' }}",
        middleware.Database,
        //middleware.JWT.Serve,
        middleware.Permissions{Permissions: []string{"{{ table_name }}_write"}}.Serve,
        middleware.Log,
        func(ctx iris.Context) {

        repo := repositories.New{{ tableName }}Repository(ctx)
        id, _ := ctx.Params().Get{{ primaryFieldType | upperCamelize }}("{{ primaryFieldParam }}")
        item, err := repo.FindOneBy{{ primaryFieldProperty }}(id)
        if err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusNotFound)
            return
        }

        formData := item
        if err := ctx.ReadForm(&formData); err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusBadRequest)
            return
        }

        result, err := repo.Update(item,formData)
        if err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusInternalServerError)
            return
        }
        ctx.StatusCode(iris.StatusOK)
        ctx.JSON(result)

    })

    app.Delete("/{{ table_name }}/{{ '{' }}{{ primaryFieldParam }}:{{ primaryFieldType }} min(1){{ '}' }}",
        middleware.Database,
        //middleware.JWT.Serve,
        middleware.Permissions{Permissions: []string{"{{ table_name }}_write"}}.Serve,
        middleware.Log,
        func(ctx iris.Context) {


        repo := repositories.New{{ tableName }}Repository(ctx)
        id, _ := ctx.Params().Get{{ primaryFieldType | upperCamelize }}("{{ primaryFieldParam }}")
        item, err := repo.FindOneBy{{ primaryFieldProperty }}(id)
        if err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusNotFound)
            return
        }

        err = repo.Delete(item)
        if err != nil {
            log.Err(err)
            ctx.StatusCode(iris.StatusInternalServerError)
            return
        }

        ctx.StatusCode(iris.StatusOK)
        ctx.JSON(item)

    })
}
